const vappComponents=function(){const e=[{title:"Home",url:"home",icon:"home"},{title:"Bookmarks",url:"bookmarks",icon:"bookmark outline"},{title:"Files",url:"files",icon:"file alternate outline"},{title:"MdEditor",url:"mdEditor",icon:"edit outline alternate outline"}];return{Bookmarks:function(){let e=[],t=[],i=[];function o(e,n,a){if(e.a)for(let i of e.a)i.a?(t.push({name:i.b,type:n}),o(i,n,i.b)):o(i,n,a);else e.c&&(n&&(e.type=n),a&&(e.tag=a),i.push(e))}return{template:$("#page-bookmarks").html(),data:()=>({bmTypeList:[],bmTagList:[],bmList:[],checkedType:"",checkedTag:"",searchTxt:"",loading:!1}),watch:{checkedType(e){this.checkedTag="",this.bmTagList=t.filter((t=>t.type===e)),this.bmList=i.filter((t=>t.type===e))}},methods:{initSearch(){$(".ui.search").search({source:[{title:"test",actionUrl:"https://zijieke.com/semantic-ui/modules/search.php#/settings"}],minCharacters:0,selectFirstResult:!0,onSelect(e,t){}})},logout(){confirm("确认登出？")&&(localStorage.clear(),window.location.href="/login.html")},search(){this.bmList=i.filter((e=>-1!==e.b.toUpperCase().indexOf(this.searchTxt.toUpperCase())||-1!==e.c.toUpperCase().indexOf(this.searchTxt.toUpperCase()))),this.checkedTag="",this.searchTxt=""},typeClick(e){this.bmList=i.filter((t=>t.type===e))},tagClick(e){let t=e.name;e.name===this.checkedTag&&(this.checkedTag="",t=""),this.checkedTag=t,this.bmList=""!==t?i.filter((e=>!!e.tag&&e.tag===t)):i.filter((e=>e.type===this.checkedType))},refreshData(){return utils.confirm("确认重新下载书签数据?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{this.checkedType="",this.checkedTag="",i=[],e=[],t=[],this.bmTypeList=[],this.bmTagList=[],this.bmList=[],this.loadData(!0)})).catch((()=>{})),!1},loadData(e){common.getContent("json/chrome.bookmark.json",e).then((e=>{this.bmDataHandle(e)}))},bmDataHandle(n){let a=JSON.parse(n).a;for(let t of a)t.a?(o(t,t.b,null),e.push(t.b)):o(t,null,null);this.checkedType=e[0],this.bmTypeList=e,this.bmTagList=t,this.bmList=i,this.loading=!1}},mounted(){e=[],t=[],i=[],this.loadData()}}}(),Home:{template:$("#page-home").html(),data:()=>({cfg:{}}),methods:{},mounted(){this.cfg=common.getAppCfg().home}},Header:{template:$("#page-header").html(),data:()=>({title:"Yanhui1993",active:"",menus:e}),methods:{titleCall(e){this.active=e.title,this.$router.push(e.url),$(document).scrollTop(0)},toggleMenu(){utils.toggleLeftMenu()}},mounted(){this.active=location.hash.split("#/")[1]}},Files:function(){let e;return{template:$("#page-files").html(),data:()=>({selectedFile:"",fileList:[],showTree:!0}),methods:{addFile(){utils.prompt("请输入文件路径","新增文件",{inputPattern:/^[\w/](.)+[a-z]+$/,inputErrorMessage:"格式不正确"}).then((({value:e})=>{common.newFile(e,"new File init").then((()=>{this.initSemantic()}))})).catch((()=>{}))},syncFiles(){utils.confirm("是否重新同步文件树?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{common.initFileTree().then((e=>{this.initSemantic()}))})).catch((()=>{}))},deleteFile(){""!==this.selectedFile?utils.confirm(`确认删除文件[${this.selectedFile}]?`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{common.delteFile(this.selectedFile).then((e=>{this.selectedFile="",this.initSemantic()}))})).catch((()=>{})):utils.message.info("请选择文件")},loadFile(t=!1){common.getContent(this.selectedFile,t).then((i=>{let o=this.selectedFile.substr(this.selectedFile.lastIndexOf(".")+1);switch(o){case"md":o="markdown";break;default:break}monaco.editor.setModelLanguage(e.getModel(),o),e.setValue(i),t&&utils.notify.success(`已重新加载文件 ${this.selectedFile}`)}))},initMonacoEditor(){common.asyncLoadLibs(["/cdn/monaco-editor/min/vs/loader.js"]).then((()=>{require.config({paths:{vs:"../cdn/monaco-editor/min/vs"}}),require(["vs/editor/editor.main"],(()=>{e=monaco.editor.create(document.getElementById("editor-container"),{value:"点击左侧列表文件开始编辑...",language:"markdown",theme:"vs",automaticLayout:!0}),this.initEditorActions()}))}))},initSemantic(){let e,t=common.getFileListOrigin(),i=[];for(let o of t)"tree"===o.type?e&&o.path.startsWith(e.file.path)||(e={file:o,children:[]},i.push(e)):e&&-1!==o.path.indexOf(e.file.path)?e.children.push(o):i.push({file:o});let o=t.filter((e=>"blob"===e.type)).map((e=>({title:e.path})));this.fileList=i;let n=this;$("#ed-file-search").search({source:o,minCharacters:1,selectFirstResult:!0,onSelect(e,t){n.selectFile(e.title)}})},selectFile(e){this.selectedFile=e,this.loadFile()},update(){if(""===this.selectedFile)return void utils.message.info("请选择编辑文件");let t=e.getValue();common.getContent(this.selectedFile).then((e=>{e!==t?common.updateFile(this.selectedFile,t):utils.message.info("文件内容未变化！")}))},initEditorActions(){let t=[{name:"保存文件",group:"yh-file",keys:[monaco.KeyMod.CtrlCmd|monaco.KeyCode.KEY_S],call:()=>{this.update()}},{name:"清空文件树缓存",group:"yh-file",call:()=>{confirm("确认清空文件树缓存？")&&common.initFileTree().then((e=>{utils.message.success("清空文件树缓存完成！")}))}}],i=0;for(let o of t)e.addAction({id:"yh-editor-"+ ++i,label:o.name,keybindings:o.keys?o.keys:[],precondition:null,keybindingContext:null,contextMenuGroupId:o.group?o.group:"yh-editor",contextMenuOrder:1.5+i,run:o.call})}},mounted(){this.initMonacoEditor(),this.initSemantic()}}}(),MdEditor:function(){let e;return{template:$("#page-mdEditor").html(),data:()=>({selectedFile:"",fileList:[]}),methods:{updateFile(){if(""===this.selectedFile)return void utils.message.info("请选择Markdown文件");let t=e.getValue();common.updateFile(this.selectedFile,t)},deleteFile(){""!==this.selectedFile?utils.confirm(`确认删除文件[${this.selectedFile}]?`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{common.delteFile(this.selectedFile).then((t=>{this.selectedFile="",e.setValue(""),this.initSemantic()}))})).catch((()=>{})):utils.message.info("请选择Markdown文件")},syncFiles(){utils.confirm("是否重新同步文件树?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{common.initFileTree().then((e=>{this.initSemantic()}))})).catch((()=>{}))},loadFile(t=!1){common.getContent(this.selectedFile,t).then((i=>{e.setValue(i),t&&utils.message.success("文件加载完成!",`已重新加载文件 => ${this.selectedFile}`)}))},selectFile(e){this.selectedFile=e,this.loadFile()},initSemantic(){let e,t=common.getFileListOrigin().filter((e=>-1!==e.path.indexOf("md"))),i=[];for(let o of t)"tree"===o.type?(e={file:o,children:[]},i.push(e)):e&&-1!==o.path.indexOf(e.file.path)?e.children.push(o):i.push({file:o});let o=t.filter((e=>"blob"===e.type)).map((e=>({title:e.path})));this.fileList=i;let n=this;$("#md-file-search").search({source:o,minCharacters:1,selectFirstResult:!0,onSelect(e,t){n.selectFile(e.title)}})},initMdEditor(){window.define&&(window.oldDefine=window.define,window.define=void 0),common.asyncLoadLibs(["/cdn/editormd/css/editormd.min.css","/cdn/editormd/editormd-min.js"]).then((()=>{e=editormd("md-editor",{mode:"gfm",width:"100%",path:"../cdn/editormd/lib/",watch:!1,tocm:!0,taskList:!0,emoji:!0,tex:!0,flowChart:!0,sequenceDiagram:!0,toolbarIcons:["undo","redo","|","bold","del","italic","quote","uppercase","lowercase","|","h1","h2","h3","h4","h5","h6","|","list-ul","list-ol","hr","|","watch","fullscreen"],onload:()=>{window.oldDefine&&(window.define=window.oldDefine)}})}))},listenEvent(){$("#md-editor").keydown((e=>{83===e.keyCode&&e.ctrlKey&&(e.preventDefault(),this.updateFile())}))}},mounted(){this.initSemantic(),this.initMdEditor(),this.listenEvent()}}}(),menus:e}}(),vappStart=function(){const e=[{path:"/",redirect:"/home"},{path:"/home",component:vappComponents.Home},{path:"/files",component:vappComponents.Files},{path:"/bookmarks",component:vappComponents.Bookmarks},{path:"/mdEditor",component:vappComponents.MdEditor}],t=new VueRouter({routes:e});return()=>{let e=new Vue({el:"#root",components:{"app-header":vappComponents.Header},router:t,methods:{syncHeaderActive(e){this.$refs.header.active=e.path.substr(1)}},data:()=>({navLinks:[]}),mounted(){}});t.beforeEach(((t,i,o)=>{e.syncHeaderActive(t),o()})),new Vue({el:"#vapp-leftMenu",data:()=>({navLinks:[]}),methods:{itemClick(t){e.$router.push(t.url),$("#vapp-leftMenu").sidebar("toggle"),e.$refs.header.active=t.url},clearCache(){if(confirm("确认清空所有缓存?")){for(let e in localStorage)localStorage.hasOwnProperty(e)&&e&&"login-state"!==e&&localStorage.removeItem(e);location.reload()}}},mounted(){this.navLinks=vappComponents.menus}}),new Vue({el:"#vapp-login",data:()=>({username:"",password:""}),methods:{login(){return""===this.username.trim()||""===this.password.trim()?(utils.notify.warning("请输入用户名密码！"),!1):(axios.post("https://gitee.com/oauth/token",{grant_type:"password",username:this.username,password:this.password,client_id:common.config.client_id,client_secret:common.config.client_secret,scope:"projects"}).then((e=>{common.updateLogin(e),localStorage.setItem(common.storage_login,JSON.stringify(e)),utils.notify.success("登录成功"),$("#vapp-login").modal("hide")})).catch((e=>{utils.notify.error("登录失败")})),!1)}},mounted(){$("#vapp-login").modal({closable:!1,onApprove:()=>(this.login(),!1)})}})}}();$((function(){}));const utils={toggleLeftMenu(){$("#vapp-leftMenu").sidebar("toggle")},alert:Vue.prototype.$alert,message:Vue.prototype.$message,notify:Vue.prototype.$notify,prompt:Vue.prototype.$prompt,confirm:Vue.prototype.$confirm,loading:Vue.prototype.$loading},common=function(){let e={};const t="login-state",i="fileList",o="fileList_origin",n="config/vapp.json",a={client_id:"f5250ed1c6f0a51423ca06aa4faf5c10d64ce8b411c425256d22fec16a531665",client_secret:"00a0f31357ce04fe3619eab7149d7c1b4daade23677a898b8f14bb647bc25fb3",username:"yanhui1993",project:"webdata"};if("/login.html"===window.location.pathname)return{config:a};let s=localStorage.getItem(t);if("/login.html"!==window.location.pathname&&!s)return void(window.location.href=`/login.html?page=${window.location.pathname}`);let{access_token:r,created_at:c,expires_in:l,refresh_token:d}=JSON.parse(s),h={},m=[];async function u(e,t=!1){let i=localStorage.getItem(e);if(!t&&i)return g.decode(i);let o=await axios.get(`https://gitee.com/api/v5/repos/${a.username}/${a.project}/contents/${e}?access_token=${r}`);return o.content?(localStorage.setItem(e,o.content),g.decode(o.content)):(utils.message.warning(`获取文件内容失败! [${e}]`),null)}async function p(){let e=(await axios.get(`https://gitee.com/api/v5/repos/${a.username}/${a.project}/git/trees/master?access_token=${r}&recursive=1`)).tree,t={};for(let i of e)"blob"===i.type&&(t[i.path]=i.sha);return h=t,m=e,localStorage.setItem(i,JSON.stringify(t)),localStorage.setItem(o,JSON.stringify(e)),h}async function f(e){return new Promise((t=>{e.endsWith(".js")?function(e,t){let i=document.createElement("script"),o=t||function(){};i.type="text/javascript",i.readyState?i.onreadystatechange=function(){"loaded"!==i.readyState&&"complete"!==i.readyState||(i.onreadystatechange=null,o())}:i.onload=function(){o()};i.src=e,document.getElementsByTagName("head")[0].appendChild(i)}(e,(()=>{t()})):e.endsWith(".css")&&function(e,t){let i=document.createElement("link"),o=t||function(){};i.rel="stylesheet",i.readyState?i.onreadystatechange=function(){"loaded"!==i.readyState&&"complete"!==i.readyState||(i.onreadystatechange=null,o())}:i.onload=function(){o()};i.href=e,document.getElementsByTagName("head")[0].appendChild(i)}(e,(()=>{t()}))}))}const g={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t,i,o,n,a,s,r,c="",l=0;for(e=g._utf8_encode(e);l<e.length;)n=(t=e.charCodeAt(l++))>>2,a=(3&t)<<4|(i=e.charCodeAt(l++))>>4,s=(15&i)<<2|(o=e.charCodeAt(l++))>>6,r=63&o,isNaN(i)?s=r=64:isNaN(o)&&(r=64),c=c+this._keyStr.charAt(n)+this._keyStr.charAt(a)+this._keyStr.charAt(s)+this._keyStr.charAt(r);return c},decode:function(e){var t,i,o,n,a,s,r="",c=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");c<e.length;)t=this._keyStr.indexOf(e.charAt(c++))<<2|(n=this._keyStr.indexOf(e.charAt(c++)))>>4,i=(15&n)<<4|(a=this._keyStr.indexOf(e.charAt(c++)))>>2,o=(3&a)<<6|(s=this._keyStr.indexOf(e.charAt(c++))),r+=String.fromCharCode(t),64!=a&&(r+=String.fromCharCode(i)),64!=s&&(r+=String.fromCharCode(o));return r=g._utf8_decode(r)},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var t="",i=0;i<e.length;i++){var o=e.charCodeAt(i);o<128?t+=String.fromCharCode(o):o>127&&o<2048?(t+=String.fromCharCode(o>>6|192),t+=String.fromCharCode(63&o|128)):(t+=String.fromCharCode(o>>12|224),t+=String.fromCharCode(o>>6&63|128),t+=String.fromCharCode(63&o|128))}return t},_utf8_decode:function(e){for(var t="",i=0,o=c1=c2=0;i<e.length;)(o=e.charCodeAt(i))<128?(t+=String.fromCharCode(o),i++):o>191&&o<224?(c2=e.charCodeAt(i+1),t+=String.fromCharCode((31&o)<<6|63&c2),i+=2):(c2=e.charCodeAt(i+1),c3=e.charCodeAt(i+2),t+=String.fromCharCode((15&o)<<12|(63&c2)<<6|63&c3),i+=3);return t}};return async function(){return new Promise((async a=>{window.axios&&(axios.interceptors.request.use((function(e){return e}),(function(e){return Promise.reject(e)})),axios.interceptors.response.use((function(e){return 200===e.status?e.data:e}),(function(e){return 401===e.response.status&&$("#vapp-login").modal("show"),Promise.reject(e)}))),await async function(){if(Math.floor(Date.now()/1e3)-c>l){let e=await axios.post(`https://gitee.com/oauth/token?grant_type=refresh_token&refresh_token=${d}`);if(200!==e.status)return void(window.location.href="/login.html");{let i=JSON.stringify(e.data);r=e.data.access_token,localStorage.setItem(t,i),utils.notify.success("刷新token成功！")}}let a=localStorage.getItem(i),s=localStorage.getItem(o);a?(h=JSON.parse(a),m=JSON.parse(s)):await p();let f=await u(n);e=JSON.parse(f)}(),a()}))}().then(vappStart),{config:a,getFileList:function(){let e=[];for(let t in h)e.push(t);return e},getContent:u,updateFile:async function(e,t){let i=h[e];if(!i)return void utils.notify.warning(`未匹配文件 ${e}`);let o=utils.loading({text:"更新文件中..."}),n=g.encode(t);axios.put(`https://gitee.com/api/v5/repos/${a.username}/${a.project}/contents/${e}`,{access_token:r,content:n,sha:i,message:`open api update ${window.location.pathname}`}).then((()=>{o.close(),utils.notify.success(`更新[${e}]成功！`,"success"),localStorage.setItem(e,n),p()})).catch((e=>{o.close(),utils.notify.error("更新异常！","error")}))},newFile:async function(e,t){if(!e||!t)return;let i=g.encode(t),o=utils.loading({text:"新增文件中..."});return new Promise((t=>{axios.post(`https://gitee.com/api/v5/repos/${a.username}/${a.project}/contents/${e}`,{access_token:r,content:i,message:`open api new ${window.location.pathname}`}).then((async e=>{utils.notify.success("新增成功！","success"),o.close(),await p(),t()})).catch((e=>{o.close(),utils.notify.error("新增异常！","error")}))}))},delteFile:async function(e){let t=h[e];if(!t)return void utils.notify.warning(`未匹配文件 ${e}`);let i=utils.loading({text:"删除文件中..."});return new Promise((o=>{axios.delete(`https://gitee.com/api/v5/repos/${a.username}/${a.project}/contents/${e}`,{params:{access_token:r,sha:t,message:`open api delete ${window.location.pathname}`}}).then((async()=>{i.close(),utils.notify.success(`删除[${e}]成功！`,"success"),localStorage.removeItem(e),await p(),o()})).catch((e=>{i.close(),utils.notify.error("删除异常！","error")}))}))},base64:g,initFileTree:p,asyncLoadLibs:async function(e=[]){for(let t of e)await f(t)},getAppCfg:function(){return e},getFileListOrigin:function(){return m},updateLogin:function(e){r=e.access_token,c=e.created_at,l=e.expires_in,d=e.refresh_token},storage_login:t}}();