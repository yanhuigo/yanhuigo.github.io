const vappComponents=function(){const e=[{title:"Home",url:"home",icon:"home"},{title:"Bookmarks",url:"bookmarks",icon:"bookmark"},{title:"Editor",url:"editor",icon:"edit"}];const t={template:$("#page-header").html(),data:()=>({title:"Yanhui1993",active:"",menus:e}),methods:{titleCall(e){this.active=e.title,this.$router.push(e.url),$(document).scrollTop(0)},toggleMenu(){utils.toggleLeftMenu()}},mounted(){this.active=location.hash.split("#/")[1]}};return{Bookmarks:function(){let e=[],t=[],o=[];function n(e,i,a){if(e.a)for(let o of e.a)o.a?(t.push({name:o.b,type:i}),n(o,i,o.b)):n(o,i,a);else e.c&&(i&&(e.type=i),a&&(e.tag=a),o.push(e))}return{template:$("#page-bookmarks").html(),data:()=>({bmTypeList:[],bmTagList:[],bmList:[],checkedType:"",checkedTag:"",searchTxt:"",loading:!1}),watch:{checkedType(e){this.checkedTag="",this.bmTagList=t.filter((t=>t.type===e)),this.bmList=o.filter((t=>t.type===e))}},methods:{initSearch(){$(".ui.search").search({source:[{title:"test",actionUrl:"https://zijieke.com/semantic-ui/modules/search.php#/settings"}],minCharacters:0,selectFirstResult:!0,onSelect(e,t){}})},logout(){confirm("确认登出？")&&(localStorage.clear(),window.location.href="/login.html")},search(){this.bmList=o.filter((e=>-1!==e.b.toUpperCase().indexOf(this.searchTxt.toUpperCase())||-1!==e.c.toUpperCase().indexOf(this.searchTxt.toUpperCase()))),this.checkedTag="",this.searchTxt=""},typeClick(e){this.bmList=o.filter((t=>t.type===e))},tagClick(e){let t=e.name;e.name===this.checkedTag&&(this.checkedTag="",t=""),this.checkedTag=t,this.bmList=""!==t?o.filter((e=>!!e.tag&&e.tag===t)):o.filter((e=>e.type===this.checkedType))},refreshData(){return utils.confirm("确认重新下载书签数据?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{this.checkedType="",this.checkedTag="",o=[],e=[],t=[],this.bmTypeList=[],this.bmTagList=[],this.bmList=[],this.loadData(!0)})).catch((()=>{})),!1},loadData(e){common.getContent("json/chrome.bookmark.json",e).then((e=>{this.bmDataHandle(e)}))},bmDataHandle(i){let a=JSON.parse(i).a;for(let t of a)t.a?(n(t,t.b,null),e.push(t.b)):n(t,null,null);this.checkedType=e[0],this.bmTypeList=e,this.bmTagList=t,this.bmList=o,this.loading=!1}},mounted(){e=[],t=[],o=[],this.loadData()}}}(),Home:{template:$("#page-home").html(),data:()=>({cfg:{}}),methods:{},mounted(){this.cfg=common.getAppCfg().home}},Header:t,Editor:function(){let e;return{template:$("#page-editor").html(),data:()=>({selectedFile:"",fileList:[]}),methods:{addFile(){utils.prompt("请输入文件路径","新增文件",{inputPattern:/^[\w/](.)+[a-z]+$/,inputErrorMessage:"格式不正确"}).then((({value:e})=>{common.newFile(e,"new File init").then((()=>{this.initSemantic()}))})).catch((()=>{}))},syncFiles(){utils.confirm("是否重新同步文件树?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{common.initFileTree().then((e=>{this.initSemantic()}))})).catch((()=>{}))},loadFile(t=!1){common.getContent(this.selectedFile,t).then((o=>{let n=this.selectedFile.substr(this.selectedFile.lastIndexOf(".")+1);switch(n){case"md":n="markdown";break;default:break}monaco.editor.setModelLanguage(e.getModel(),n),e.setValue(o),t&&tip("文件加载完成!",`已重新加载文件 => ${this.selectedFile}`)}))},initMonacoEditor(){common.asyncLoadLibs(["/cdn/monaco-editor/min/vs/loader.js"]).then((()=>{require.config({paths:{vs:"/cdn/monaco-editor/min/vs"}}),require(["vs/editor/editor.main"],(()=>{e=monaco.editor.create(document.getElementById("editor-container"),{value:"start edit gitee files...",language:"markdown",theme:"vs",automaticLayout:!0}),this.initEditorActions()}))}))},initSemantic(){let e=common.getFileList();this.fileList=e;let t=e.map((e=>({title:e}))),o=this;$("#ed-file-search").search({source:t,minCharacters:1,selectFirstResult:!0,onSelect(e,t){o.selectFile(e.title)}})},selectFile(e){this.selectedFile=e,this.loadFile()},update(){if(""===this.selectedFile)return void utils.message.info("请选择编辑文件");let t=e.getValue();common.getContent(this.selectedFile).then((e=>{e!==t?common.updateFile(this.selectedFile,t):utils.message.info("文件内容未变化！")}))},initEditorActions(){let t=[{name:"保存文件",group:"yh-file",keys:[monaco.KeyMod.CtrlCmd|monaco.KeyCode.KEY_S],call:()=>{this.update()}},{name:"清空文件树缓存",group:"yh-file",call:()=>{confirm("确认清空文件树缓存？")&&common.initFileTree().then((e=>{utils.message.success("清空文件树缓存完成！")}))}}],o=0;for(let n of t)e.addAction({id:"yh-editor-"+ ++o,label:n.name,keybindings:n.keys?n.keys:[],precondition:null,keybindingContext:null,contextMenuGroupId:n.group?n.group:"yh-editor",contextMenuOrder:1.5+o,run:n.call})}},mounted(){this.initMonacoEditor(),this.initSemantic()}}}(),menus:e}}(),vappStart=function(){const e=[{path:"/",redirect:"/home"},{path:"/home",component:vappComponents.Home},{path:"/editor",component:vappComponents.Editor},{path:"/bookmarks",component:vappComponents.Bookmarks}],t=new VueRouter({routes:e});return()=>{let e=new Vue({el:"#root",components:{"app-header":vappComponents.Header},router:t,methods:{},data:()=>({navLinks:[]}),mounted(){}});window.tip=e.tip,new Vue({el:"#vapp-leftMenu",data:()=>({navLinks:[]}),methods:{itemClick(t){e.$router.push(t.url),$("#vapp-leftMenu").sidebar("toggle"),e.$refs.header.active=t.url}},mounted(){this.navLinks=vappComponents.menus}})}}();$((function(){}));const utils={toggleLeftMenu(){$("#vapp-leftMenu").sidebar("toggle")},alert:Vue.prototype.$alert,message:Vue.prototype.$message,notify:Vue.prototype.$notify,prompt:Vue.prototype.$prompt,confirm:Vue.prototype.$confirm},common=function(){let e={};const t="login-state",o="fileList",n="json/vapp.json",i={client_id:"f5250ed1c6f0a51423ca06aa4faf5c10d64ce8b411c425256d22fec16a531665",client_secret:"00a0f31357ce04fe3619eab7149d7c1b4daade23677a898b8f14bb647bc25fb3",username:"yanhui1993",project:"webdata"};if("/login.html"===window.location.pathname)return{config:i};let a=localStorage.getItem(t);if("/login.html"!==window.location.pathname&&!a)return void(window.location.href=`/login.html?page=${window.location.pathname}`);let{access_token:r,created_at:s,expires_in:c,refresh_token:l}=JSON.parse(a),h={};async function m(e,t=!1){let o=localStorage.getItem(e);if(!t&&o)return p.decode(o);let n=await axios.get(`https://gitee.com/api/v5/repos/${i.username}/${i.project}/contents/${e}?access_token=${r}`);return n.content?(localStorage.setItem(e,n.content),p.decode(n.content)):(utils.message.warning(`获取文件内容失败! [${e}]`),null)}async function d(){let e=(await axios.get(`https://gitee.com/api/v5/repos/${i.username}/${i.project}/git/trees/master?access_token=${r}&recursive=1`)).tree,t={};for(let o of e)"blob"===o.type&&(t[o.path]=o.sha);return h=t,localStorage.setItem(o,JSON.stringify(t)),h}async function u(e){return new Promise((t=>{!function(e,t){let o=document.createElement("script"),n=t||function(){};o.type="text/javascript",o.readyState?o.onreadystatechange=function(){"loaded"!==o.readyState&&"complete"!==o.readyState||(o.onreadystatechange=null,n())}:o.onload=function(){n()};o.src=e,document.getElementsByTagName("head")[0].appendChild(o)}(e,(()=>{t()}))}))}const p={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t,o,n,i,a,r,s,c="",l=0;for(e=p._utf8_encode(e);l<e.length;)i=(t=e.charCodeAt(l++))>>2,a=(3&t)<<4|(o=e.charCodeAt(l++))>>4,r=(15&o)<<2|(n=e.charCodeAt(l++))>>6,s=63&n,isNaN(o)?r=s=64:isNaN(n)&&(s=64),c=c+this._keyStr.charAt(i)+this._keyStr.charAt(a)+this._keyStr.charAt(r)+this._keyStr.charAt(s);return c},decode:function(e){var t,o,n,i,a,r,s="",c=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");c<e.length;)t=this._keyStr.indexOf(e.charAt(c++))<<2|(i=this._keyStr.indexOf(e.charAt(c++)))>>4,o=(15&i)<<4|(a=this._keyStr.indexOf(e.charAt(c++)))>>2,n=(3&a)<<6|(r=this._keyStr.indexOf(e.charAt(c++))),s+=String.fromCharCode(t),64!=a&&(s+=String.fromCharCode(o)),64!=r&&(s+=String.fromCharCode(n));return s=p._utf8_decode(s)},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var t="",o=0;o<e.length;o++){var n=e.charCodeAt(o);n<128?t+=String.fromCharCode(n):n>127&&n<2048?(t+=String.fromCharCode(n>>6|192),t+=String.fromCharCode(63&n|128)):(t+=String.fromCharCode(n>>12|224),t+=String.fromCharCode(n>>6&63|128),t+=String.fromCharCode(63&n|128))}return t},_utf8_decode:function(e){for(var t="",o=0,n=c1=c2=0;o<e.length;)(n=e.charCodeAt(o))<128?(t+=String.fromCharCode(n),o++):n>191&&n<224?(c2=e.charCodeAt(o+1),t+=String.fromCharCode((31&n)<<6|63&c2),o+=2):(c2=e.charCodeAt(o+1),c3=e.charCodeAt(o+2),t+=String.fromCharCode((15&n)<<12|(63&c2)<<6|63&c3),o+=3);return t}};return async function(){return new Promise((async i=>{window.axios&&(axios.interceptors.request.use((function(e){return e}),(function(e){return Promise.reject(e)})),axios.interceptors.response.use((function(e){return 200===e.status?e.data:e}),(function(e){if(401!==e.response.status||"/login.html"===window.location.pathname)return Promise.reject(e);window.location.href="/login.html"}))),await async function(){if(Math.floor(Date.now()/1e3)-s>c){let e=await axios.post(`https://gitee.com/oauth/token?grant_type=refresh_token&refresh_token=${l}`);if(200!==e.status)return void(window.location.href="/login.html");{let o=JSON.stringify(e.data);r=e.data.access_token,localStorage.setItem(t,o),utils.notify.success("刷新token成功！")}}let i=localStorage.getItem(o);i?h=JSON.parse(i):await d();let a=await m(n);e=JSON.parse(a)}(),i()}))}().then(vappStart),{config:i,getFileList:function(){let e=[];for(let t in h)e.push(t);return e},getContent:m,updateFile:async function(e,t){let o=h[e];if(!o)return void utils.notify.warning(`未匹配匹配文件 ${e}`);let n=p.encode(t);axios.put(`https://gitee.com/api/v5/repos/${i.username}/${i.project}/contents/${e}`,{access_token:r,content:n,sha:o,message:`open api update ${window.location.pathname}`}).then((()=>{utils.notify.success(`更新[${e}]成功！`,"success"),localStorage.setItem(e,n),d()})).catch((e=>{utils.notify.error("更新异常！","error")}))},newFile:async function(e,t){if(!e||!t)return;let o=p.encode(t);return new Promise((t=>{axios.post(`https://gitee.com/api/v5/repos/${i.username}/${i.project}/contents/${e}`,{access_token:r,content:o,message:`open api new ${window.location.pathname}`}).then((async e=>{utils.notify.success("新增成功！","success"),await d(),t()})).catch((e=>{utils.notify.error("新增异常！","error")}))}))},base64:p,initFileTree:d,asyncLoadLibs:async function(e=[]){for(let t of e)await u(t)},getAppCfg:function(){return e}}}();