const vappComponents=function(){const e=[{title:"Home",url:"home",icon:"home"},{title:"Editor",url:"editor",icon:"edit"},{title:"Links",children:[{title:"semantic-ui",url:"https://zijieke.com/semantic-ui/"}]}];const t={template:$("#page-header").html(),data:()=>({title:"Yanhui",active:"",menus:e}),methods:{titleCall(e){this.active=e.title,this.$router.push(e.url)},toggleMenu(){utils.toggleLeftMenu()}},mounted(){this.active=location.hash.split("#/")[1]}};return{Home:function(){let e=[],t=[],i=[];function o(e,n,a){if(e.a)for(let i of e.a)i.a?(t.push({name:i.b,type:n}),o(i,n,i.b)):o(i,n,a);else e.c&&(n&&(e.type=n),a&&(e.tag=a),i.push(e))}return{template:$("#page-home").html(),data:()=>({bmTypeList:[],bmTagList:[],bmList:[],checkedType:"",checkedTag:"",searchTxt:"",loading:!1}),watch:{checkedType(e){this.checkedTag="",this.bmTagList=t.filter((t=>t.type===e)),this.bmList=i.filter((t=>t.type===e))}},methods:{initSearch(){$(".ui.search").search({source:[{title:"test",actionUrl:"https://zijieke.com/semantic-ui/modules/search.php#/settings"}],minCharacters:0,selectFirstResult:!0,onSelect(e,t){}})},logout(){confirm("确认登出？")&&(localStorage.clear(),window.location.href="/login.html")},search(){this.bmList=i.filter((e=>-1!==e.b.toUpperCase().indexOf(this.searchTxt.toUpperCase())||-1!==e.c.toUpperCase().indexOf(this.searchTxt.toUpperCase()))),this.checkedTag="",this.searchTxt=""},typeClick(e){this.bmList=i.filter((t=>t.type===e))},tagClick(e){let t=e.name;e.name===this.checkedTag&&(this.checkedTag="",t=""),this.checkedTag=t,this.bmList=""!==t?i.filter((e=>!!e.tag&&e.tag===t)):i.filter((e=>e.type===this.checkedType))},refreshData(){return confirm("确认重新下载书签数据？")&&(this.loading=!0,this.checkedType="",this.checkedTag="",i=[],e=[],t=[],this.bmTypeList=[],this.bmTagList=[],this.bmList=[],this.loadData(!0),setTimeout((()=>{this.loading=!1}),3e3)),!1},loadData(e){common.getContent("json/chrome.bookmark.json",e).then((e=>{this.bmDataHandle(e)}))},bmDataHandle(n){let a=JSON.parse(n).a;for(let t of a)t.a?(o(t,t.b,null),e.push(t.b)):o(t,null,null);this.checkedType=e[0],this.bmTypeList=e,this.bmTagList=t,this.bmList=i,this.loading=!1}},mounted(){e=[],t=[],i=[],this.loadData()}}}(),Header:t,Editor:function(){let e;return{template:$("#page-editor").html(),data:()=>({selectedFile:"",fileList:[]}),methods:{loadFile(t=!1){common.getContent(this.selectedFile,t).then((i=>{let o=this.selectedFile.substr(this.selectedFile.lastIndexOf(".")+1);switch(o){case"md":o="markdown";break;default:break}monaco.editor.setModelLanguage(e.getModel(),o),e.setValue(i),t&&tip("文件加载完成!",`已重新加载文件 => ${this.selectedFile}`)}))},initMonacoEditor(){common.asyncLoadLibs(["/cdn/monaco-editor/min/vs/loader.js"]).then((()=>{require.config({paths:{vs:"/cdn/monaco-editor/min/vs"}}),require(["vs/editor/editor.main"],(()=>{e=monaco.editor.create(document.getElementById("editor-container"),{value:"start edit gitee files...",language:"markdown",theme:"vs",automaticLayout:!0}),this.initEditorActions()}))}))},initSemantic(){let e=common.getFileList();this.fileList=e;let t=e.map((e=>({title:e}))),i=this;$("#ed-file-search").search({source:t,minCharacters:1,selectFirstResult:!0,onSelect(e,t){i.selectFile(e.title)}})},selectFile(e){this.selectedFile=e,this.loadFile()},update(){if(""===this.selectedFile)return void tip.info("请选择编辑文件");let t=e.getValue();common.updateFile(this.selectedFile,t)},initEditorActions(){let t=[{name:"保存文件",group:"yh-file",keys:[monaco.KeyMod.CtrlCmd|monaco.KeyCode.KEY_S],call:()=>{this.update()}},{name:"清空文件树缓存",group:"yh-file",call:()=>{confirm("确认清空文件树缓存？")&&common.initFileTree().then((e=>{tip.success("清空文件树缓存完成！")}))}}],i=0;for(let o of t)e.addAction({id:"yh-editor-"+ ++i,label:o.name,keybindings:o.keys?o.keys:[],precondition:null,keybindingContext:null,contextMenuGroupId:o.group?o.group:"yh-editor",contextMenuOrder:1.5+i,run:o.call})}},mounted(){this.initMonacoEditor(),this.initSemantic()}}}(),menus:e}}(),vappStart=function(){const e=[{path:"/",redirect:"/home"},{path:"/home",component:vappComponents.Home},{path:"/editor",component:vappComponents.Editor}],t=new VueRouter({routes:e});return()=>{let e=new Vue({el:"#root",components:{"app-header":vappComponents.Header},router:t,methods:{},data:()=>({navLinks:[]}),mounted(){}});window.tip=e.tip,new Vue({el:"#vapp-leftMenu",data:()=>({navLinks:[]}),methods:{itemClick(t){e.$router.push(t.url),$("#vapp-leftMenu").sidebar("toggle"),e.$refs.header.active=t.url}},mounted(){this.navLinks=vappComponents.menus}})}}();$((function(){let e=$("#vapp-msg");e.on("click",(function(){e.transition("fade")})),window.tip={},tip.info=(t,i)=>{i&&e.addClass(i),e.transition("fade"),$("#vapp-msg-content").html(t),setTimeout((()=>{e.transition("fade"),i&&e.removeClass(i)}),2e3)},tip.success=e=>{tip.info(e,"positive")},tip.error=e=>{tip.info(e,"negative")}}));const utils={toggleLeftMenu(){$("#vapp-leftMenu").sidebar("toggle")}},common=function(){let e={};const t="login-state",i="fileList",o="json/config.json",n={client_id:"f5250ed1c6f0a51423ca06aa4faf5c10d64ce8b411c425256d22fec16a531665",client_secret:"00a0f31357ce04fe3619eab7149d7c1b4daade23677a898b8f14bb647bc25fb3",username:"yanhui1993",project:"webdata"};if("/login.html"===window.location.pathname)return{config:n};let a=localStorage.getItem(t);if("/login.html"!==window.location.pathname&&!a)return void(window.location.href=`/login.html?page=${window.location.pathname}`);let{access_token:r,created_at:s,expires_in:c,refresh_token:l}=JSON.parse(a),d={};function h(e,t){window.tip?window.tip[t](e):window.Notification?Notification.requestPermission((function(t){let i=new Notification(e,{body:detail,dir:"rtl",icon:"https://yanhui1993.gitee.io/imgs/logo.jpg"});i.onshow=function(){setTimeout(i.close.bind(i),3e3)}})):alert(e)}async function m(e,t=!1){let i=localStorage.getItem(e);if(!t&&i)return f.decode(i);let o=await axios.get(`https://gitee.com/api/v5/repos/${n.username}/${n.project}/contents/${e}?access_token=${r}`);return o.content?(localStorage.setItem(e,o.content),f.decode(o.content)):null}async function u(){let e=(await axios.get(`https://gitee.com/api/v5/repos/${n.username}/${n.project}/git/trees/master?access_token=${r}&recursive=1`)).tree,t={};for(let i of e)"blob"===i.type&&(t[i.path]=i.sha);return d=t,localStorage.setItem(i,JSON.stringify(t)),d}async function p(e){return new Promise((t=>{!function(e,t){let i=document.createElement("script"),o=t||function(){};i.type="text/javascript",i.readyState?i.onreadystatechange=function(){"loaded"!==i.readyState&&"complete"!==i.readyState||(i.onreadystatechange=null,o())}:i.onload=function(){o()};i.src=e,document.getElementsByTagName("head")[0].appendChild(i)}(e,(()=>{t()}))}))}const f={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t,i,o,n,a,r,s,c="",l=0;for(e=f._utf8_encode(e);l<e.length;)n=(t=e.charCodeAt(l++))>>2,a=(3&t)<<4|(i=e.charCodeAt(l++))>>4,r=(15&i)<<2|(o=e.charCodeAt(l++))>>6,s=63&o,isNaN(i)?r=s=64:isNaN(o)&&(s=64),c=c+this._keyStr.charAt(n)+this._keyStr.charAt(a)+this._keyStr.charAt(r)+this._keyStr.charAt(s);return c},decode:function(e){var t,i,o,n,a,r,s="",c=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");c<e.length;)t=this._keyStr.indexOf(e.charAt(c++))<<2|(n=this._keyStr.indexOf(e.charAt(c++)))>>4,i=(15&n)<<4|(a=this._keyStr.indexOf(e.charAt(c++)))>>2,o=(3&a)<<6|(r=this._keyStr.indexOf(e.charAt(c++))),s+=String.fromCharCode(t),64!=a&&(s+=String.fromCharCode(i)),64!=r&&(s+=String.fromCharCode(o));return s=f._utf8_decode(s)},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var t="",i=0;i<e.length;i++){var o=e.charCodeAt(i);o<128?t+=String.fromCharCode(o):o>127&&o<2048?(t+=String.fromCharCode(o>>6|192),t+=String.fromCharCode(63&o|128)):(t+=String.fromCharCode(o>>12|224),t+=String.fromCharCode(o>>6&63|128),t+=String.fromCharCode(63&o|128))}return t},_utf8_decode:function(e){for(var t="",i=0,o=c1=c2=0;i<e.length;)(o=e.charCodeAt(i))<128?(t+=String.fromCharCode(o),i++):o>191&&o<224?(c2=e.charCodeAt(i+1),t+=String.fromCharCode((31&o)<<6|63&c2),i+=2):(c2=e.charCodeAt(i+1),c3=e.charCodeAt(i+2),t+=String.fromCharCode((15&o)<<12|(63&c2)<<6|63&c3),i+=3);return t}};return async function(){return new Promise((async n=>{window.axios&&(axios.interceptors.request.use((function(e){return e}),(function(e){return Promise.reject(e)})),axios.interceptors.response.use((function(e){return 200===e.status?e.data:e}),(function(e){if(401!==e.response.status||"/login.html"===window.location.pathname)return Promise.reject(e);window.location.href="/login.html"}))),await async function(){if(Math.floor(Date.now()/1e3)-s>c){let e=await axios.post(`https://gitee.com/oauth/token?grant_type=refresh_token&refresh_token=${l}`);if(200!==e.status)return void(window.location.href="/login.html");{let i=JSON.stringify(e.data);r=e.data.access_token,localStorage.setItem(t,i)}}let n=localStorage.getItem(i);n?d=JSON.parse(n):await u();let a=await m(o);e=JSON.parse(a)}(),n()}))}().then(vappStart),{config:n,getFileList:function(){let e=[];for(let t in d)e.push(t);return e},getContent:m,updateFile:async function(e,t){let i=d[e];if(!i)return void h(`未匹配匹配文件 ${e}`,"info");let o=f.encode(t);axios.put(`https://gitee.com/api/v5/repos/${n.username}/${n.project}/contents/${e}`,{access_token:r,content:o,sha:i,message:`open api update ${window.location.pathname}`}).then((()=>{h(`更新[${e}]成功！`,"success"),localStorage.setItem(e,o),u()})).catch((e=>{h("更新异常！","error")}))},newFile:async function(e,t){if(!e||!t)return;let i=f.encode(t);axios.post(`https://gitee.com/api/v5/repos/${n.username}/${n.project}/contents/${e}`,{access_token:r,content:i,message:`open api new ${window.location.pathname}`}).then((e=>{h("新增成功！","success"),u()})).catch((e=>{h("新增异常！","error")}))},base64:f,tip:h,initFileTree:u,asyncLoadLibs:async function(e=[]){for(let t of e)await p(t)},getAppCfg:function(){return e}}}();