define(["axios","base64","utils"],(function(e,t,n){const o="webdata",a={lsRepo:"gitee-repo",lsLoginState:"login-state",lsFileTree:"file-Tree"};let r,c=localStorage.getItem(a.lsRepo),i={client_id:"f5250ed1c6f0a51423ca06aa4faf5c10d64ce8b411c425256d22fec16a531665",client_secret:"00a0f31357ce04fe3619eab7149d7c1b4daade23677a898b8f14bb647bc25fb3",reposUrlPrefix:"https://gitee.com/api/v5/repos/yanhui1993",repo:c||o},s={loginState:{},fileShaMap:new Map};async function l(t=!1,n=o){return new Promise(((o,c)=>{let s=p(a.lsFileTree,!0,n);!s||t?e.get(`${i.reposUrlPrefix}/${n}/git/trees/master?${r?"access_token="+r:""}&recursive=1`).then((e=>{f(a.lsFileTree,e.tree,n),u(!1,n),o(e.tree)})).catch((e=>{c(e)})):o(s)}))}function f(e,t,n=o){"object"==typeof t?localStorage.setItem(`${n}#${e}`,JSON.stringify(t)):localStorage.setItem(`${n}#${e}`,t)}function p(e,t=!0,n=o){let a=localStorage.getItem(`${n}#${e}`);return a?t?JSON.parse(a):a:null}async function u(e=!1,t){return new Promise(((n,o)=>{if(!t)return null;l(e,t).then((e=>{for(let t of e)s.fileShaMap.set(`${i.repo}#${t.path}`,t.sha);n()})).catch((e=>{o(e)}))}))}return{getFileTree:l,getFileContent:async function(a,c=!1,s=!1,l=o){let u=p(a,!1,l);if(!c&&u){let e=t.decode(u);return s?JSON.parse(e):e}let g=await e.get(`${i.reposUrlPrefix}/${l}/contents/${a}?${r?"access_token="+r:""}`);if(!g.content)return n.message(`获取文件内容失败! [${a}]`,"error"),null;f(a,g.content,l);let $=t.decode(g.content);return s?JSON.parse($):$},newFile:async function(a,c,s=o){if(!a||!c)return null;let l=t.encode(c);return new Promise((t=>{e.post(`${i.reposUrlPrefix}/${s}/contents/${a}`,{access_token:r,content:l,message:`open api new ${window.location.pathname}`}).then((async e=>{n.notify("新增成功！","success"),await u(!0,s),t(e)})).catch((e=>{n.notify("新增异常！","error")}))}))},updateFile:async function(a,c,l=o){let p=s.fileShaMap.get(`${l}#${a}`);if(!p)return n.notify(`未匹配文件 ${l}#${a}`,"warning"),null;let g=t.encode(c);return new Promise((t=>{e.put(`${i.reposUrlPrefix}/${l}/contents/${a}`,{access_token:r,content:g,sha:p,message:`open api update ${window.location.pathname}`}).then((async()=>{n.notify(`更新[${a}]成功！`,"success"),f(a,g,l),await u(!0,l),t()})).catch((e=>{n.notify("更新异常！","error")}))}))},deleteFile:async function(t,a=o){let c=s.fileShaMap.get(`${a}#${t}`);return c?new Promise((s=>{e.delete(`${i.reposUrlPrefix}/${a}/contents/${t}`,{params:{access_token:r,sha:c,message:`open api delete ${window.location.pathname}`}}).then((async()=>{n.notify(`删除[${t}]成功！`,"success"),function(e,t=o){localStorage.removeItem(`${t}#${e}`)}(t,a),await u(!0,a),s()})).catch((e=>{}))})):(n.notify(`未匹配文件 ${a}#${t}`,"warning"),null)},initState:async function(){return new Promise((async(e,t)=>{!function(){let e=localStorage.getItem(a.lsLoginState);if(!e)return;s.loginState=JSON.parse(e),r=s.loginState.access_token}(),u(!1,i.repo).then((()=>{e()})).catch((t=>{n.goLogin(),e()}))}))},clearAllCache:function(){for(let e in localStorage)localStorage.hasOwnProperty(e)&&e&&e!==a.lsLoginState&&localStorage.removeItem(e);location.reload()},setRepo:function(e){i.repo=e,localStorage.setItem(a.lsRepo,e),n.message(`切换数据源[${e}]成功！`)},getRepo:function(){return i.repo},storageKey:a,apiConfig:i}}));