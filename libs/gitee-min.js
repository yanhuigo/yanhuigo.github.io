define(["axios","base64","utils","sysLog"],(function(e,t,n,o){const a="webdata",r={lsRepo:"gitee-repo",lsLoginState:"wyd-login-state",lsFileTree:"file-Tree"};let c,i=localStorage.getItem(r.lsRepo),s={client_id:"f5250ed1c6f0a51423ca06aa4faf5c10d64ce8b411c425256d22fec16a531665",client_secret:"00a0f31357ce04fe3619eab7149d7c1b4daade23677a898b8f14bb647bc25fb3",reposUrlPrefix:"https://gitee.com/api/v5/repos/yanhui1993",repo:i||a},l={},f={loginState:{},fileShaMap:new Map};async function $(t=!1,n=a){return new Promise(((a,i)=>{let l=p(r.lsFileTree,!0,n);!l||t?e.get(`${s.reposUrlPrefix}/${n}/git/trees/master?${c?"access_token="+c:""}&recursive=1`).then((e=>{u(r.lsFileTree,e.tree,n),h(!1,n),a(e.tree),o.addLog(`[${n}]获取仓库文件树`)})).catch((e=>{i(e)})):a(l)}))}async function g(r,i=!1,l=!1,f=a){let $,g=`@${r}`,h=p(g,!1,f);if($=h||p(r,!1,f),!i&&$)return l?JSON.parse($):$;let y=await e.get(`${s.reposUrlPrefix}/${f}/contents/${r}?${c?"access_token="+c:""}`);if(!y.content)return n.message(`获取文件内容失败! [${r}]`,"error"),null;let m=t.decode(y.content);return d(g,f),u(r,m,f),o.addLog(`[${f}]下载文件 ${r}`),l?JSON.parse(m):m}function u(e,t,n=a){"object"==typeof t?localStorage.setItem(`${n}#${e}`,JSON.stringify(t)):localStorage.setItem(`${n}#${e}`,t)}function p(e,t=!0,n=a){let o=localStorage.getItem(`${n}#${e}`);return o?t?JSON.parse(o):o:null}function d(e,t=a){localStorage.removeItem(`${t}#${e}`),localStorage.removeItem(`${t}#@${e}`)}async function h(e=!1,t){return new Promise(((n,o)=>{if(!t)return null;$(e,t).then((e=>{for(let t of e)f.fileShaMap.set(`${s.repo}#${t.path}`,t.sha);n()})).catch((e=>{o(e)}))}))}return{getFileTree:$,getFileContent:g,newFile:async function(r,i,l=a){if(!r||!i)return null;let f=t.encode(i);return new Promise((t=>{e.post(`${s.reposUrlPrefix}/${l}/contents/${r}`,{access_token:c,content:f,message:`open api new ${window.location.pathname}`}).then((async e=>{n.notify("新增成功！","success"),await h(!0,l),t(e),o.addLog(`[${l}]新增文件 ${r}`)})).catch((e=>{n.notify("新增异常！","error")}))}))},updateFile:async function(r,i,l=a){let $=f.fileShaMap.get(`${l}#${r}`);if(!$)return n.notify(`未匹配文件 ${l}#${r}`,"warning"),null;let g=t.encode(i);return new Promise((a=>{e.put(`${s.reposUrlPrefix}/${l}/contents/${r}`,{access_token:c,content:g,sha:$,message:`open api update ${window.location.pathname}`}).then((async()=>{n.notify(`上传[${r}]成功！`,"success"),d(r,l),u(r,t.decode(g),l),await h(!0,l),a(),o.addLog(`[${l}]上传文件 ${r}`)})).catch((e=>{n.notify("上传异常！","error")}))}))},deleteFile:async function(t,r=a){let i=f.fileShaMap.get(`${r}#${t}`);return i?new Promise((a=>{e.delete(`${s.reposUrlPrefix}/${r}/contents/${t}`,{params:{access_token:c,sha:i,message:`open api delete ${window.location.pathname}`}}).then((async()=>{n.notify(`删除[${t}]成功！`,"success"),d(t,r),await h(!0,r),a(),o.addLog(`[${r}]删除文件 ${t}`)})).catch((e=>{n.notify("删除异常！","error")}))})):(n.notify(`未匹配文件 ${r}#${t}`,"warning"),null)},initState:async function(){return new Promise((async(e,t)=>{!function(){let e=localStorage.getItem(r.lsLoginState);if(!e)return;f.loginState=JSON.parse(e),c=f.loginState.access_token}(),g("config/wyd2021.json",!1,!0).then((e=>{l=e})).catch((e=>{})),h(!1,s.repo).then((()=>{e()})).catch((t=>{n.goLogin(),e()}))}))},clearAllCache:function(){for(let e in localStorage)localStorage.hasOwnProperty(e)&&e&&!e.startsWith("wyd-")&&localStorage.removeItem(e)},setRepo:function(e){s.repo=e,localStorage.setItem(r.lsRepo,e),n.message(`切换数据源[${e}]成功！`)},getRepo:function(){return s.repo},storageKey:r,apiConfig:s,getWydConfig:function(){return l},updateFileCache:function(e,t,o=a){if(!f.fileShaMap.get(`${o}#${e}`))return n.notify(`未匹配文件 ${o}#${e}`,"warning"),null;u(`@${e}`,t,o),n.notify(`更新[${e}]成功！`,"success")}}}));