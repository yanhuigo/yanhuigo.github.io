define(["vue","require","gitee","utils","jquery","semantic"],(function(e,t,i,n){return{data:()=>({selectedFile:"",fileList:[],showTree:!0,showIframe:!0,renderFileContent:"<h2>Hello</h2>",repo:i.getRepo()}),methods:{setRepo(e){this.repo=e,e!==i.getRepo()&&(this.selectedFile="",editor.setValue(""),i.setRepo(e),this.initSemantic(!1))},closeIframe(){this.showIframe=!1},previewInIframe(){$("#ed-iframe-modal").modal("show");let e=editor.getValue();this.renderFileContent=e,this.showIframe=!0},runJs(){let e=editor.getModel().getValueInRange(editor.getSelection());window.eval(e)},addFile(){n.prompt("请输入文件路径","新增文件",{inputPattern:/^[\w/](.)+[a-z]+$/,inputErrorMessage:"格式不正确"}).then((({value:e})=>{i.newFile(e,"new File init",this.repo).then((()=>{this.initSemantic(!0)}))})).catch((()=>{}))},syncFiles(){n.confirm("是否重新同步文件树?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{i.getFileTree(!0,this.repo).then((e=>{n.notify("同步文件树完成！"),this.initSemantic(!0)}))})).catch((()=>{}))},deleteFile(){""!==this.selectedFile?n.confirm(`确认删除文件[${this.selectedFile}]?`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{i.deleteFile(this.selectedFile,this.repo).then((e=>{editor.setValue(""),this.selectedFile="",this.initSemantic(!0)}))})).catch((()=>{})):n.message("请选择文件","info")},loadFile(e=!1){i.getFileContent(this.selectedFile,e,!1,this.repo).then((t=>{let i=this.selectedFile.substr(this.selectedFile.lastIndexOf(".")+1);switch(i){case"md":i="markdown";break;case"js":i="javascript";break;default:break}monaco.editor.setModelLanguage(editor.getModel(),i),editor.setValue(t),e&&n.notify(`已重新加载文件 ${this.selectedFile}`,"success")}))},initMonacoEditor(){t(["vs/editor/editor.main"],(()=>{editor=monaco.editor.create(document.getElementById("editor-container"),{value:"点击左侧列表文件开始编辑...",language:"markdown",theme:"vs",automaticLayout:!0}),this.initEditorActions()}))},async initSemantic(e=!1){let t,n=await i.getFileTree(e,this.repo),l=[];for(let e of n)"tree"===e.type?t&&e.path.startsWith(t.file.path+"/")||(t={file:e,children:[]},l.push(t)):t&&-1!==e.path.indexOf(t.file.path)?t.children.push(e):l.push({file:e});let s=n.filter((e=>"blob"===e.type)).map((e=>({title:e.path})));this.fileList=l;let o=this;$("#ed-file-search").search({source:s,minCharacters:1,selectFirstResult:!0,onSelect(e,t){o.selectFile(e.title)}})},selectFile(e){this.selectedFile=e,this.loadFile()},update(){if(""===this.selectedFile)return void n.message("请选择编辑文件","info");let e=editor.getValue();i.getFileContent(this.selectedFile,!1,!1,this.repo).then((t=>{t!==e?i.updateFile(this.selectedFile,e,this.repo):n.message("文件内容未变化！","info")}))},initEditorActions(){let e=[{name:"保存文件",group:"yh-file",keys:[monaco.KeyMod.CtrlCmd|monaco.KeyCode.KEY_S],call:()=>{this.update()}},{name:"清空文件树缓存",group:"yh-file",call:()=>{confirm("确认清空文件树缓存？")&&common.initFileTree().then((e=>{n.message("清空文件树缓存完成！")}))}}],t=0;for(let i of e)editor.addAction({id:"yh-editor-"+ ++t,label:i.name,keybindings:i.keys?i.keys:[],precondition:null,keybindingContext:null,contextMenuGroupId:i.group?i.group:"yh-editor",contextMenuOrder:1.5+t,run:i.call})}},mounted(){this.initMonacoEditor(),this.initSemantic()},template:'\n            <div class="mt-header d-sm-flex ui segment m-2" wydFlag="editor" style="height: 90vh">\n                \n                <button v-if="!showTree" class="ui icon button green" title="显示文件树" style="height: 3rem"\n                        @click="showTree=!showTree">\n                    <i class="arrow right icon"></i>\n                </button>\n                \n                <div class="ui vertical menu p-1 m-0 file-tree overflow-auto w-100-xs-only" style="min-width:240px;" v-show="showTree">\n                    <div class="d-flex justify-content-start flex-wrap wyd-editor-operations">\n                        <div class="ui buttons w-100">\n                              <button @click="setRepo(\'webdata\')" class="ui button" :class="repo===\'webdata\'?\'active teal\':\'\'"><i class="heart icon"></i>webData</button>\n                              <div class="or"></div>\n                              <button @click="setRepo(\'webme\')" class="ui button" :class="repo===\'webme\'?\'active red\':\'\'"><i class="user secret icon"></i>webMe</button>\n                        </div>\n                        <el-tooltip content="新增文件" placement="bottom">\n                            <button class="ui compact icon button small" @click="addFile">\n                                <i class="plus icon"></i>\n                            </button>\n                        </el-tooltip>\n                        <el-tooltip content="同步文件树" placement="bottom">\n                            <button class="ui compact icon button" @click="syncFiles">\n                                <i class="sync alternate icon"></i>\n                            </button>\n                        </el-tooltip>\n                        <el-tooltip content="隐藏文件树" placement="bottom">\n                            <button v-show="showTree" class="ui compact icon button" @click="showTree=!showTree">\n                                <i class="arrow left icon"></i>\n                            </button>\n                        </el-tooltip>\n                        <template v-if="selectedFile" >\n                            <el-tooltip content="保存文件(Ctrl+s)" placement="bottom">\n                                <button class="ui compact icon teal button" @click="update">\n                                    <i class="save alternate outline icon"></i>\n                                </button>\n                            </el-tooltip>\n                            <el-tooltip content="同步文件" placement="bottom">\n                                <button class="ui compact icon teal button ml-1" @click="loadFile(true)">\n                                    <i class="cloud download icon"></i>\n                                </button>\n                            </el-tooltip>\n                            <el-tooltip content="删除文件" placement="bottom">\n                                <button class="ui compact teal icon button ml-1" @click="deleteFile">\n                                    <i class="trash alternate outline icon"></i>\n                                </button>\n                            </el-tooltip>\n                            <el-tooltip content="在iframe中预览" placement="bottom">\n                                <button v-if="selectedFile.endsWith(\'.html\')||selectedFile.endsWith(\'.js\')" class="ui compact icon green button" @click="previewInIframe">\n                                    <i class="html5 icon"></i>\n                                </button>\n                            </el-tooltip>\n                            <el-tooltip content="运行选中的js" placement="bottom">\n                                <button v-if="selectedFile.endsWith(\'.js\')" class="ui compact icon green button" @click="runJs">\n                                    <i class="node js icon"></i>\n                                </button>\n                            </el-tooltip>\n                        </template>\n                    </div>\n                    <div class="item ui search my-1" id="ed-file-search">\n                        <div class="ui icon input search">\n                            <input class="prompt" type="text" placeholder="Search Files..."/>\n                            <i class="search icon"></i>\n                        </div>\n                        <div class="results"></div>\n                    </div>\n                    <div class="item" v-for="file in fileList">\n                        <template v-if="file.children">\n                            <div class="header">{{file.file.path}}</div>\n                            <div class="menu" v-for="subFile in file.children">\n                                <a class="item" @click="selectFile(subFile.path)" :class="selectedFile===subFile.path ? \'active teal\':\'\'">\n                                    <i class="icon git"></i>\n                                    {{subFile.path.split(file.file.path + "/")[1]}} \n                                </a>\n                            </div>\n                        </template>\n                        <div class="menu" v-else>\n                            <a class="item" @click="selectFile(file.file.path)" :class="selectedFile===file.file.path ? \'active teal\':\'\'">\n                                {{file.file.path}} \n                            </a>\n                        </div>\n                    </div>\n                </div>\n                \n                <div class="flex-grow-1 d-md-flex flex-column w-100-xs-only">\n                    <div class="flex-grow-1 vh-50-xs-only" id="editor-container"></div>\n                    <div class="ui raised segment m-0">\n                        <a class="ui ribbon label" :class="selectedFile ? \'green\':\'\'">编辑信息</a>\n                        <span class="font-weight-bold" v-if="selectedFile">\n                                正在编辑 <span class="ui label">{{selectedFile}}</span>\n                            </span>\n                        <span class="font-weight-bold" v-else>\n                                请选择编辑文件！\n                        </span>\n                        \n                        </button>\n                    </div>\n                </div>\n                \x3c!--<div class="w-25">\n                    预览区域\n                </div>--\x3e\n                \n                <div id="ed-iframe-modal" class="ui modal large">\n                  <div class="header">{{selectedFile}}</div>\n                  <div class="content p-0">\n                    <iframe class="border-0" :srcdoc="renderFileContent" width="100%" height="600px"></iframe>\n                  </div>\n                  <div class="actions">\n                    <div class="ui cancel button">取消</div>\n                  </div>\n                </div>\n                    \n            </div>\n        '}}));