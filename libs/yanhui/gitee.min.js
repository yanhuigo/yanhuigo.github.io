define(["axios","base64","utils","sysLog"],(function(e,t,n,o){const a="webdata",r={lsRepo:"gitee-repo",lsLoginState:"wyd-login-state",lsFileTree:"file-Tree"};let s=localStorage.getItem(r.lsRepo);s||localStorage.setItem(r.lsRepo,a);let i,c={client_id:"f5250ed1c6f0a51423ca06aa4faf5c10d64ce8b411c425256d22fec16a531665",client_secret:"00a0f31357ce04fe3619eab7149d7c1b4daade23677a898b8f14bb647bc25fb3",reposUrlPrefix:"https://gitee.com/api/v5/repos/yanhui1993",repo:s||a},l={},f={loginState:{},fileShaMap:new Map};async function g(t=!1,n=a){return new Promise(((a,s)=>{let l=u(r.lsFileTree,!0,n);!l||t?e.get(`${c.reposUrlPrefix}/${n}/git/trees/master?${i?"access_token="+i:""}&recursive=1`).then((e=>{p(r.lsFileTree,e.tree,n),d(!1,n),a(e.tree),o.addLog(`[${n}]获取仓库文件树`)})).catch((e=>{s(e)})):a(l)}))}async function $(r,s=!1,l=!1,f=a){let g,$=`@${r}`,d=u($,!1,f);if(g=d||u(r,!1,f),!s&&g)return l?JSON.parse(g):g;let S=await e.get(`${c.reposUrlPrefix}/${f}/contents/${r}${f!==a&&i?"?access_token="+i:""}`);if(!S.content)return n.message(`获取文件内容失败! [${r}]`,"error"),null;let m=t.decode(S.content);return h($,f),p(r,m,f),o.addLog(`[${f}]下载文件 ${r}`),l?JSON.parse(m):m}function p(e,t,n=a){"object"==typeof t?localStorage.setItem(`${n}#${e}`,JSON.stringify(t)):localStorage.setItem(`${n}#${e}`,t)}function u(e,t=!0,n=a){let o=localStorage.getItem(`${n}#${e}`);return o?t?JSON.parse(o):o:null}function h(e,t=a){localStorage.removeItem(`${t}#${e}`),localStorage.removeItem(`${t}#@${e}`)}async function d(e=!1,t){return new Promise(((n,o)=>{if(!t)return null;g(e,t).then((e=>{for(let t of e)f.fileShaMap.set(`${c.repo}#${t.path}`,t.sha);n()})).catch((e=>{o(e)}))}))}return{getFileTree:g,getFileContent:$,newFile:async function(r,s,l=a){if(!r||!s)return null;let f=t.encode(s);return new Promise((t=>{e.post(`${c.reposUrlPrefix}/${l}/contents/${r}`,{access_token:i,content:f,message:`open api new ${window.location.pathname}`}).then((async e=>{n.notify("新增成功！","success"),await d(!0,l),t(e),o.addLog(`[${l}]新增文件 ${r}`)})).catch((e=>{n.notify("新增异常！","error")}))}))},updateFile:async function(r,s,l=a,g=!0){let $=f.fileShaMap.get(`${l}#${r}`);if(!$)return n.notify(`未匹配文件 ${l}#${r}`,"warning"),null;let u=t.encode(s);return new Promise((a=>{e.put(`${c.reposUrlPrefix}/${l}/contents/${r}`,{access_token:i,content:u,sha:$,message:`open api update ${window.location.pathname}`}).then((async()=>{n.notify(`上传[${r}]成功！`,"success"),h(r,l),p(r,t.decode(u),l),g&&await d(!0,l),a(),o.addLog(`[${l}]上传文件 ${r}`)})).catch((e=>{n.notify("上传异常！","error")}))}))},deleteFile:async function(t,r=a){let s=f.fileShaMap.get(`${r}#${t}`);return s?new Promise((a=>{e.delete(`${c.reposUrlPrefix}/${r}/contents/${t}`,{params:{access_token:i,sha:s,message:`open api delete ${window.location.pathname}`}}).then((async()=>{n.notify(`删除[${t}]成功！`,"success"),h(t,r),await d(!0,r),a(),o.addLog(`[${r}]删除文件 ${t}`)})).catch((e=>{n.notify("删除异常！","error")}))})):(n.notify(`未匹配文件 ${r}#${t}`,"warning"),null)},initState:async function(){return new Promise((async(e,t)=>{!function(){let e=localStorage.getItem(r.lsLoginState);if(!e)return;f.loginState=JSON.parse(e),i=f.loginState.access_token}(),$("config/wyd2021.json",!1,!0).then((e=>{l=e})).catch((e=>{})),d(!1,c.repo).then((()=>{e()})).catch((t=>{n.goLogin(),e()}))}))},clearAllCache:function(){for(let e in localStorage)localStorage.hasOwnProperty(e)&&e&&!e.startsWith("wyd-")&&localStorage.removeItem(e)},setRepo:function(e){c.repo=e,localStorage.setItem(r.lsRepo,e),n.message(`切换数据源[${e}]成功！`)},getRepo:function(){return c.repo},storageKey:r,apiConfig:c,getWydConfig:function(){return l},updateFileCache:function(e,t,o=a){if(!f.fileShaMap.get(`${o}#${e}`))return n.notify(`未匹配文件 ${o}#${e}`,"warning"),null;p(`@${e}`,t,o),n.notify(`更新[${e}]成功！`,"success")},refreshToken:function(t){let n=localStorage.getItem(r.lsLoginState);if(n){let o=JSON.parse(n),{created_at:a,expires_in:s,refresh_token:i}=o;Math.floor(Date.now()/1e3)-a>s?e.post(`https://gitee.com/oauth/token?grant_type=refresh_token&refresh_token=${i}`).then((e=>{localStorage.setItem(r.lsLoginState,JSON.stringify(e))})):t&&t(o)}}}}));