define(["axios","base64","utils"],(function(e,t,n){const o="https://gitee.com/api/v5/repos/yanhui1993/webdata",a="login-state",c="file-Tree";let i,r={loginState:{},fileShaMap:new Map};async function s(t=!1){return new Promise((n=>{let a=f(c);!a||t?e.get(`${o}/git/trees/master?access_token=${i}&recursive=1`).then((e=>{l(c,e.tree),u(),n(e.tree)})):n(a)}))}function l(e,t){"object"==typeof t?localStorage.setItem(e,JSON.stringify(t)):localStorage.setItem(e,t)}function f(e,t=!0){let n=localStorage.getItem(e);return n?t?JSON.parse(n):n:null}async function u(e=!1){let t=await s(e);for(let e of t)r.fileShaMap.set(e.path,e.sha)}function g(){var e;e="token过期",n.confirm(`确认跳转到到登录页?[${e}]`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{window.location.href=`/login.html?page=${window.location.pathname}`})).catch((()=>{}))}return{getFileTree:s,getFileContent:async function(a,c=!1,r=!1){let s=f(a,!1);if(!c&&s){let e=t.decode(s);if(r)return JSON.parse(e)}let u=await e.get(`${o}/contents/${a}?access_token=${i}`);if(!u.content)return n.message(`获取文件内容失败! [${a}]`,"error"),null;l(a,u.content);let g=t.decode(u.content);return r?JSON.parse(g):g},newFile:async function(a,c){if(!a||!c)return;let r=t.encode(c);return new Promise((t=>{e.post(`${o}/contents/${a}`,{access_token:i,content:r,message:`open api new ${window.location.pathname}`}).then((async e=>{n.notify("新增成功！","success"),t(e)})).catch((e=>{n.notify("新增异常！","error")}))}))},updateFile:async function(a,c){let s=r.fileShaMap.get(a);if(!s)return void n.notify(`未匹配文件 ${a}`,"warning");let f=t.encode(c);return new Promise((t=>{e.put(`${o}/contents/${a}`,{access_token:i,content:f,sha:s,message:`open api update ${window.location.pathname}`}).then((async()=>{n.notify(`更新[${a}]成功！`,"success"),l(a,f),await u(!0),t()})).catch((e=>{n.notify("更新异常！","error")}))}))},deleteFile:async function(t){let a=r.fileShaMap.get(t);if(a)return new Promise((c=>{e.delete(`${o}/contents/${t}`,{params:{access_token:i,sha:a,message:`open api delete ${window.location.pathname}`}}).then((async()=>{n.notify(`删除[${t}]成功！`,"success"),c()})).catch((e=>{}))}))},initState:async function(){return new Promise((async(e,t)=>{!function(){let e=localStorage.getItem(a);if(!e)return void g();r.loginState=JSON.parse(e),i=r.loginState.access_token}(),await u(),e()}))},goLogin:g,clearAllCache:function(){for(let e in localStorage)localStorage.hasOwnProperty(e)&&e&&e!==a&&localStorage.removeItem(e);location.reload()}}}));