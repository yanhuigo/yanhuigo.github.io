define(["vue","require","gitee","utils","jquery","semantic"],(function(e,t,i,n){return{data:()=>({selectedFile:"",fileList:[],showTree:!0,showIframe:!0,renderFileContent:"<h2>Hello</h2>"}),methods:{closeIframe(){this.showIframe=!1},previewInIframe(){$("#ed-iframe-modal").modal("show");let e=editor.getValue();this.renderFileContent=e,this.showIframe=!0},runJs(){let e=editor.getModel().getValueInRange(editor.getSelection());window.eval(e)},addFile(){n.prompt("请输入文件路径","新增文件",{inputPattern:/^[\w/](.)+[a-z]+$/,inputErrorMessage:"格式不正确"}).then((({value:e})=>{i.newFile(e,"new File init").then((()=>{this.initSemantic(!0)}))})).catch((()=>{}))},syncFiles(){n.confirm("是否重新同步文件树?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{i.getFileTree(!0).then((e=>{n.notify("同步文件树完成！"),this.initSemantic(!0)}))})).catch((()=>{}))},deleteFile(){""!==this.selectedFile?n.confirm(`确认删除文件[${this.selectedFile}]?`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{i.deleteFile(this.selectedFile).then((e=>{this.selectedFile="",this.initSemantic(!0)}))})).catch((()=>{})):n.message("请选择文件","info")},loadFile(e=!1){i.getFileContent(this.selectedFile,e).then((t=>{let i=this.selectedFile.substr(this.selectedFile.lastIndexOf(".")+1);switch(i){case"md":i="markdown";break;case"js":i="javascript";break;default:break}monaco.editor.setModelLanguage(editor.getModel(),i),editor.setValue(t),e&&n.notify(`已重新加载文件 ${this.selectedFile}`,"success")}))},initMonacoEditor(){t(["vs/editor/editor.main"],(()=>{editor=monaco.editor.create(document.getElementById("editor-container"),{value:"点击左侧列表文件开始编辑...",language:"markdown",theme:"vs",automaticLayout:!0}),this.initEditorActions()}))},async initSemantic(e=!1){let t,n=await i.getFileTree(e),l=[];for(let e of n)"tree"===e.type?t&&e.path.startsWith(t.file.path+"/")||(t={file:e,children:[]},l.push(t)):t&&-1!==e.path.indexOf(t.file.path)?t.children.push(e):l.push({file:e});let s=n.filter((e=>"blob"===e.type)).map((e=>({title:e.path})));this.fileList=l;let a=this;$("#ed-file-search").search({source:s,minCharacters:1,selectFirstResult:!0,onSelect(e,t){a.selectFile(e.title)}})},selectFile(e){this.selectedFile=e,this.loadFile()},update(){if(""===this.selectedFile)return void n.message("请选择编辑文件","info");let e=editor.getValue();i.getFileContent(this.selectedFile).then((t=>{t!==e?i.updateFile(this.selectedFile,e):n.message("文件内容未变化！","info")}))},initEditorActions(){let e=[{name:"保存文件",group:"yh-file",keys:[monaco.KeyMod.CtrlCmd|monaco.KeyCode.KEY_S],call:()=>{this.update()}},{name:"清空文件树缓存",group:"yh-file",call:()=>{confirm("确认清空文件树缓存？")&&common.initFileTree().then((e=>{n.message("清空文件树缓存完成！")}))}}],t=0;for(let i of e)editor.addAction({id:"yh-editor-"+ ++t,label:i.name,keybindings:i.keys?i.keys:[],precondition:null,keybindingContext:null,contextMenuGroupId:i.group?i.group:"yh-editor",contextMenuOrder:1.5+t,run:i.call})}},mounted(){this.initMonacoEditor(),this.initSemantic()},template:'\n            <div class="mt-header d-sm-flex ui segment m-2" wydFlag="editor" style="height: 90vh">\n                <button v-if="!showTree" class="ui icon button green" title="显示文件树" style="height: 3rem"\n                        @click="showTree=!showTree">\n                    <i class="arrow right icon"></i>\n                </button>\n                <div class="ui vertical menu p-1 m-0 file-tree overflow-auto" style="min-width:240px;" v-show="showTree">\n                    <div class="ui icon buttons ml-3 my-1">\n                        <button class="ui button" data-tooltip="新增文件" data-position="bottom center" @click="addFile">\n                            <i class="plus icon"></i>\n                        </button>\n                        <button class="ui button" data-tooltip="同步文件树" data-position="bottom center" @click="syncFiles">\n                            <i class="sync alternate icon"></i>\n                        </button>\n                        <button v-show="showTree" class="ui button" data-tooltip="隐藏文件树" data-position="bottom center"\n                                @click="showTree=!showTree">\n                            <i class="arrow left icon"></i>\n                        </button>\n                    </div>\n                    <div class="item ui search my-1" id="ed-file-search">\n                        <div class="ui icon input search">\n                            <input class="prompt" type="text" placeholder="Search Files..."/>\n                            <i class="search icon"></i>\n                        </div>\n                        <div class="results"></div>\n                    </div>\n                    <div class="item" v-for="file in fileList">\n                        <template v-if="file.children">\n                            <div class="header">{{file.file.path}}</div>\n                            <div class="menu" v-for="subFile in file.children"><a class="item"\n                                                                                  @click="selectFile(subFile.path)"\n                                                                                  :class="selectedFile===subFile.path ? \'active teal\':\'\'"><i\n                                    class="icon git"></i>{{subFile.path.split(file.file.path + "/")[1]}} </a></div>\n                        </template>\n                        <div class="menu" v-else><a class="item" @click="selectFile(file.file.path)"\n                                                    :class="selectedFile===file.file.path ? \'active teal\':\'\'">{{file.file.path}} </a>\n                        </div>\n                    </div>\n                </div>\n                <div class="flex-grow-1 d-md-flex flex-column">\n                    <div class="flex-grow-1" id="editor-container"></div>\n                    <div class="ui raised segment m-0">\n                        <a class="ui ribbon label" :class="selectedFile ? \'green\':\'\'">编辑信息</a>\n                        <span class="font-weight-bold" v-if="selectedFile">\n                                正在编辑 <span class="ui label teal">{{selectedFile}}</span>\n                            </span>\n                        <span class="font-weight-bold" v-else>\n                                请选择编辑文件！\n                        </span>\n                        \n                        </button>\n                        <button v-if="selectedFile" class="ui compact icon button ml-1" data-tooltip="刷新文件"\n                                data-position="top center" @click="loadFile(true)"><i\n                                class="sync alternate icon"></i></button>\n                        <button v-if="selectedFile"\n                                class="ui compact negative icon button ml-1" data-tooltip="删除文件" data-position="top center"\n                                @click="deleteFile"><i class="trash alternate outline icon"></i></button>\n                    </div>\n                </div>\n                \x3c!--<div class="w-25">\n                    预览区域\n                </div>--\x3e\n                \n                <div class="wyd-position-right" >\n                    <button v-if="selectedFile && (selectedFile.endsWith(\'.html\')||selectedFile.endsWith(\'.js\'))" class="ui compact icon teal button" data-tooltip="在iframe中预览" data-position="top center" @click="previewInIframe">\n                        <i class="html5 icon large"></i>\n                    </button>\n                    <button v-if="selectedFile && selectedFile.endsWith(\'.js\')" class="ui compact icon teal button" data-tooltip="运行选中的js" data-position="top center" @click="runJs">\n                        <i class="node js icon large"></i>\n                    </button>\n                    <button v-if="selectedFile" class="ui compact icon teal button" data-tooltip="保存文件(Ctrl+s)" data-position="top center" @click="update">\n                        <i class="save alternate outline icon large"></i>\n                    </button>\n                </div>\n                \n                <div id="ed-iframe-modal" class="ui modal large">\n                  <div class="header">{{selectedFile}}</div>\n                  <div class="content p-0">\n                    <iframe class="border-0" :srcdoc="renderFileContent" width="100%" height="600px"></iframe>\n                  </div>\n                  <div class="actions">\n                    <div class="ui cancel button">取消</div>\n                  </div>\n                </div>\n                    \n            </div>\n        '}}));